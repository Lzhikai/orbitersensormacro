# This file includes a variable stored in a file in ~/filamentsensor.cfg
# This is to make the macro to check condition that filament has runout or the unload button has been pushed before allowing a reload to execute.

[save_variables]
filename: ~/filamentsensor.cfg

[gcode_button filament_load]
pin: PA1                     # FS - use the input pin you have connected the sensor to
press_gcode:
    {% set printing = printer.state %}
    M118 {printing}
    {% if printer.idle_timeout.state == "Printing" %}
        M118 "In PRESS PRINTING if statement"
        SAVE_VARIABLE VARIABLE=loadbutton VALUE='True'
        PAUSE
    {% else %}
        M118 "In PRESS else statement"
        M118 {printing}
    {% endif %}
release_gcode:
  {% set temp_target = 235 %}
  {% set paused = printer.pause_resume.is_paused == 'True' %}  
  {% if printer.pause_resume.is_paused and printer.save_variables.variables.loadbutton %}
      SAVE_VARIABLE VARIABLE=loadbutton VALUE='False'
      SAVE_GCODE_STATE NAME=loading_filament
      M118 "In RELEASE PAUSED if STATEMENT"
      debugprint
      M118 {printer.state}
      M82                          # set extruder to absolute mode
      #G92 E0                       # zero extruder position
      G4 P2000                     # wait for two seconds
      FORCE_MOVE STEPPER=extruder DISTANCE=20 VELOCITY=5 ACCEL=1000  # load filament inside the gears - force move needs to be enabled
      FORCE_MOVE STEPPER=extruder DISTANCE=150 VELOCITY=5 ACCEL=1000
      #G1 E150 F300                 # extrude 150mm
      M400                         # wait for current move to finish
      G92 E0
      RESTORE_GCODE_STATE NAME=loading_filament
      M118 Done Executing
  {% elif not printer.pause_resume.is_paused and printer.save_variables.variables.loadbutton %}
      SAVE_VARIABLE VARIABLE=loadbutton VALUE='False'
      M118 "in RELEASE else STATEMENT"
      debugprint
      M118 {printer.state}
      M82                          # set extruder to absolute mode
      G92 E0                       # zero extruder position
      G4 P3000                     # wait for three seconds
      FORCE_MOVE STEPPER=extruder DISTANCE=20 VELOCITY=5 ACCEL=1000  # load filament inside the gears - force move needs to be enabled
      
      {% if printer.extruder.temperature < temp_target|float*0.9 %}
            M109 S{temp_target|float*0.9} # wait till 0.9 of extruder temp is reached, then continue  
      {% endif %}
      
      M104 S{temp_target}       #continue heating to preset no waiting
      FORCE_MOVE STEPPER=extruder DISTANCE=150 VELOCITY=5 ACCEL=1000
      #G1 E150 F300                 # extrude 150mm
      M400                         # wait for current move to finish
      M104 S0                      # set hotend temperature to 0
      #G92 E0                       # zero extruder position
      M118 Done Executing
  {% else %}
      M118 Reached Error State
  {% endif %}
  
  
[gcode_button filament_unload]
pin: PA2                     # SU - use the input pin you have connected the sensor to
press_gcode:
    M117
release_gcode:
  {% set temp_target = 235 %}
  {% if printer.idle_timeout.state == "Printing" %}
      M117 Not allowed!
      UPDATE_DELAYED_GCODE ID=clear_display DURATION=10
  {% else %}
      M117 Filament unload
      UPDATE_DELAYED_GCODE ID=clear_display DURATION=10
      M82                      # set extruder to absolute mode
      
      
      #M104 S{temp_target}           # Set extruder temperature no waiting
      
      {% if printer.extruder.temperature < temp_target|float*0.9 %}
            M109 S{temp_target|float*0.9} # wait till 0.9 of extruder temp is reached, then continue  
      {% endif %}
      
      M104 S{temp_target}       #continue heating to preset no waiting
      G4 P5000                     # wait for five seconds
      #G92 E0                   # zero extruder position
      FORCE_MOVE STEPPER=extruder DISTANCE=10 VELOCITY=2 ACCEL=1000  # load filament inside the gears - force move needs to be enabled
      #G0 E10 F300             # extrude filament to shape tip @300mm/min
      #G92 E0
      FORCE_MOVE STEPPER=extruder DISTANCE=-5 VELOCITY=10 ACCEL=1000  # load filament inside the gears - force move needs to be enabled
      #G0 E-5 F3600             # extract filament to cold end
      FORCE_MOVE STEPPER=extruder DISTANCE=-80 VELOCITY=5 ACCEL=1000  # load filament inside the gears - force move needs to be enabled
      #G0 E-80 F300             # continue extraction slow allow filament to be cooled enough before reaches the gears
      FORCE_MOVE STEPPER=extruder DISTANCE=-50 VELOCITY=7.5 ACCEL=1000  # load filament inside the gears - force move needs to be enabled
      #G1 E-50 F1500            # retract additional filament fast
      M104 S0                  # set hotend temperature to 0
      M300                     # play single beep - only works if you have the M300 macro in use
      
  {% endif %}
